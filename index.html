<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MiniPalette Forge</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0f1115;color:#e9eef7}
header{padding:18px 16px 6px}
h1{margin:0;font-size:22px}
.app{display:grid;grid-template-columns:1.1fr 1.2fr .9fr;gap:14px;padding:12px 16px 18px}
section{background:#16191f;border:1px solid #2c3444;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.35);overflow:hidden;display:flex;flex-direction:column}
section header{padding:12px 14px;border-bottom:1px solid #2c3444;background:rgba(255,255,255,.03)}
section h2{margin:0;font-size:16px}
.content{padding:12px 14px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{background:#2a3040;border:1px solid #2c3444;border-radius:999px;padding:8px 12px;font-size:12px;display:inline-flex;align-items:center;gap:8px}
.search{display:flex;gap:8px}
.search input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #2c3444;background:#0f131c;color:#e9eef7}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px}
.card{border:1px solid #2c3444;border-radius:12px;background:#1b2030;display:flex;flex-direction:column;overflow:hidden}
.swatch{height:84px}
.swatch .hex{position:relative;top:56px;left:8px;background:rgba(0,0,0,.45);padding:2px 6px;border-radius:8px;font-size:12px;width:max-content}
.actions{padding:10px;display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
button,select{appearance:none;border-radius:10px;border:1px solid #2c3444;background:#0d1220;color:#e9eef7;padding:8px 10px;font-size:13px;cursor:pointer}
.btn-accent{background:linear-gradient(180deg,#215fbf,#174f9f);border-color:#1a4d94}
.shortlist{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.mini{display:flex;gap:8px;align-items:center;background:#131827;border:1px solid #2c3444;border-radius:10px;padding:6px 8px;font-size:12px}
.mini .dot{width:18px;height:18px;border-radius:6px;border:1px solid rgba(255,255,255,.25)}
.scheme{display:grid;gap:12px}
.slots{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}
.slot{background:#141a28;border:1px solid #2c3444;border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
.slot .slot-swatch{height:40px;border-radius:8px;border:1px solid rgba(255,255,255,.15)}
.preview{border:1px solid #2c3444;border-radius:12px;overflow:hidden}
.preview .toolbar{display:flex;gap:8px;padding:8px;border-bottom:1px solid #2c3444;background:rgba(255,255,255,.02)}
.stage{height:230px}
.notes{margin-top:10px;background:#121725;border:1px solid #2c3444;border-radius:12px;padding:10px}
.tiny{font-size:11px;color:#b6bfce}
.footer{text-align:center;color:#b6bfce;font-size:12px;padding:10px 0 18px}
@media(max-width:1200px){.app{grid-template-columns:1fr 1fr}}
@media(max-width:900px){.app{grid-template-columns:1fr}.slots{grid-template-columns:1fr 1fr}}
@media(max-width:480px){.slots{grid-template-columns:1fr}.grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}}
</style>
</head>
<body>
<header><h1>MiniPalette Forge</h1><div class="tiny">Swatches are approximate. Always test on a spoon or spare bit.</div></header>
<main class="app">
<section id="catalogPane"><header><h2>Catalog & Filters</h2></header>
<div class="content">
  <div class="chips">
    <label class="chip"><input type="checkbox" class="brandFilter" value="Games Workshop" checked> Games Workshop</label>
    <label class="chip"><input type="checkbox" class="brandFilter" value="Army Painter" checked> Army Painter</label>
    <label class="chip"><input type="checkbox" class="brandFilter" value="Vallejo" checked> Vallejo</label>
  </div>
  <div class="search"><input id="searchInput" placeholder="Search paint name..." aria-label="Search by paint name"><button id="clearSearch">Clear</button></div>
  <div class="grid" id="catalogGrid"></div>
  <details style="margin-top:10px"><summary><strong>Shortlist</strong> - pin paints for quick access</summary><div class="shortlist" id="shortlist"></div></details>
</div></section>
<section id="schemePane"><header><h2>Scheme Generator</h2></header>
<div class="content scheme">
<div class="row">
  <button id="generateBtn" class="btn-accent">Generate scheme</button>
  <div class="row" style="margin-left:auto;gap:8px"><label class="chip">Theme <select id="themeSelect"></select></label> <span class="tiny" id="themeCount"></span></div>
</div>
<div class="tiny" id="themePrompt">Theme prompt here.</div>
<div class="row">
  <label class="chip"><input type="checkbox" id="accentMetallic"> metallic accent</label>
  <label class="chip">Edge <select id="edgeSel"><option value="0">subtle</option><option value="1">high-contrast</option></select></label>
  <label class="chip">Weathering <select id="weathSel"><option value="0">none</option><option value="1">light</option><option value="2">heavy</option></select></label>
</div>
<div class="slots" id="slots"></div>
<div class="preview" id="preview"><div class="toolbar"><button class="pill" data-mode="armor">Armor panels</button><button class="pill" data-mode="cloth">Cloth and leather</button><button class="pill" data-mode="mech">Mechanicals and trim</button></div><div class="stage" id="stage"></div></div>
<div class="notes"><strong>Suggested Steps</strong><ul id="suggestedSteps" style="margin:8px 0 0 18px"></ul></div>
<div class="notes"><strong>Recipe Notes</strong><div id="recipeNotes" style="margin-top:6px;white-space:pre-wrap" class="tiny"></div></div>
</div></section>
<section id="codePane"><header><h2>Recipe Code & Data</h2></header>
<div class="content">
  <div class="row" style="gap:8px"><input id="codeInput" placeholder="Recipe code" style="flex:1"><button id="copyCode">Copy code</button><button id="loadCode">Load code</button></div>
  <details><summary><strong>Scheme JSON</strong> - export or import</summary><div class="row"><button id="exportScheme">Export scheme to JSON</button><input type="file" id="importSchemeFile" accept="application/json"><button id="importScheme">Import scheme JSON</button></div></details>
  <details><summary><strong>Paints JSON</strong> - expand catalog</summary><div class="row"><button id="exportPaints">Export paints JSON</button><input type="file" id="importPaintsFile" accept="application/json"><button id="importPaintsMerge">Import paints JSON - merge</button><button id="importPaintsReplace">Import paints JSON - replace</button></div></details>
  <details><summary><strong>Local Storage</strong> - quick save and load</summary><div class="row"><button id="saveScheme">Save current scheme</button><select id="savedSelect" style="min-width:160px"></select><button id="loadSaved">Load</button><button id="deleteSaved">Delete saved</button></div></details>
</div></section>
</main>
<div class="footer">MiniPalette Forge - v1 · <a href="#codePane">View data panel</a></div>
<div class="toast" id="toast" style="display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b0f17;border:1px solid #2c3444;border-radius:12px;padding:10px 14px">toast</div>
<script>
const VERSION=1;
const paints = [{"id": "Games Workshop|Base|Abaddon Black", "brand": "Games Workshop", "series": "Base", "name": "Abaddon Black", "hex": "#0b0c0e", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Base|Corax White", "brand": "Games Workshop", "series": "Base", "name": "Corax White", "hex": "#f2f4f6", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Base|Wraithbone", "brand": "Games Workshop", "series": "Base", "name": "Wraithbone", "hex": "#e8e3cf", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Base|Mechanicus Standard Grey", "brand": "Games Workshop", "series": "Base", "name": "Mechanicus Standard Grey", "hex": "#5b616b", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Base|Leadbelcher", "brand": "Games Workshop", "series": "Base", "name": "Leadbelcher", "hex": "#8a8e92", "isMetallic": true, "isNeutral": false}, {"id": "Games Workshop|Base|Runelord Brass", "brand": "Games Workshop", "series": "Base", "name": "Runelord Brass", "hex": "#7a5a2a", "isMetallic": true, "isNeutral": false}, {"id": "Games Workshop|Base|Retributor Armour", "brand": "Games Workshop", "series": "Base", "name": "Retributor Armour", "hex": "#b58a28", "isMetallic": true, "isNeutral": false}, {"id": "Games Workshop|Base|Mephiston Red", "brand": "Games Workshop", "series": "Base", "name": "Mephiston Red", "hex": "#8d1e1e", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Base|Khorne Red", "brand": "Games Workshop", "series": "Base", "name": "Khorne Red", "hex": "#5c181a", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Layer|Evil Sunz Scarlet", "brand": "Games Workshop", "series": "Layer", "name": "Evil Sunz Scarlet", "hex": "#b22a2a", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Layer|Troll Slayer Orange", "brand": "Games Workshop", "series": "Layer", "name": "Troll Slayer Orange", "hex": "#e56a1f", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Layer|Yriel Yellow", "brand": "Games Workshop", "series": "Layer", "name": "Yriel Yellow", "hex": "#f2cd1d", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Base|Averland Sunset", "brand": "Games Workshop", "series": "Base", "name": "Averland Sunset", "hex": "#d9a321", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Base|Zamesi Desert", "brand": "Games Workshop", "series": "Base", "name": "Zamesi Desert", "hex": "#c49d4c", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Layer|Caledor Sky", "brand": "Games Workshop", "series": "Layer", "name": "Caledor Sky", "hex": "#3182c2", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Base|Kantor Blue", "brand": "Games Workshop", "series": "Base", "name": "Kantor Blue", "hex": "#2a3d73", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Base|Macragge Blue", "brand": "Games Workshop", "series": "Base", "name": "Macragge Blue", "hex": "#264a9b", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Base|Caliban Green", "brand": "Games Workshop", "series": "Base", "name": "Caliban Green", "hex": "#1f3b26", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Base|Waaagh! Flesh", "brand": "Games Workshop", "series": "Base", "name": "Waaagh! Flesh", "hex": "#255032", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Layer|Thunderhawk Blue", "brand": "Games Workshop", "series": "Layer", "name": "Thunderhawk Blue", "hex": "#406b78", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Layer|Russ Grey", "brand": "Games Workshop", "series": "Layer", "name": "Russ Grey", "hex": "#6b8a9a", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Layer|Dawnstone", "brand": "Games Workshop", "series": "Layer", "name": "Dawnstone", "hex": "#8b9198", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Layer|Ushabti Bone", "brand": "Games Workshop", "series": "Layer", "name": "Ushabti Bone", "hex": "#d9cfb1", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Layer|Stormhost Silver", "brand": "Games Workshop", "series": "Layer", "name": "Stormhost Silver", "hex": "#cfd3d8", "isMetallic": true, "isNeutral": false}, {"id": "Games Workshop|Layer|Liberator Gold", "brand": "Games Workshop", "series": "Layer", "name": "Liberator Gold", "hex": "#c29d3c", "isMetallic": true, "isNeutral": false}, {"id": "Games Workshop|Shade|Nuln Oil", "brand": "Games Workshop", "series": "Shade", "name": "Nuln Oil", "hex": "#1c1f24", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Shade|Agrax Earthshade", "brand": "Games Workshop", "series": "Shade", "name": "Agrax Earthshade", "hex": "#5a4a34", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Contrast|Apothecary White", "brand": "Games Workshop", "series": "Contrast", "name": "Apothecary White", "hex": "#e9edf1", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Contrast|Skeleton Horde", "brand": "Games Workshop", "series": "Contrast", "name": "Skeleton Horde", "hex": "#c7b07d", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Contrast|Snakebite Leather", "brand": "Games Workshop", "series": "Contrast", "name": "Snakebite Leather", "hex": "#8a6b3d", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Contrast|Wyldwood", "brand": "Games Workshop", "series": "Contrast", "name": "Wyldwood", "hex": "#4b3b2b", "isMetallic": false, "isNeutral": true}, {"id": "Army Painter|Fanatic Core|Matt Black", "brand": "Army Painter", "series": "Fanatic Core", "name": "Matt Black", "hex": "#0a0b0d", "isMetallic": false, "isNeutral": true}, {"id": "Army Painter|Fanatic Core|Matt White", "brand": "Army Painter", "series": "Fanatic Core", "name": "Matt White", "hex": "#f4f6f7", "isMetallic": false, "isNeutral": true}, {"id": "Army Painter|Fanatic Core|Skeleton Bone", "brand": "Army Painter", "series": "Fanatic Core", "name": "Skeleton Bone", "hex": "#d9cba5", "isMetallic": false, "isNeutral": true}, {"id": "Army Painter|Fanatic Core|Leather Brown", "brand": "Army Painter", "series": "Fanatic Core", "name": "Leather Brown", "hex": "#6a4b2f", "isMetallic": false, "isNeutral": true}, {"id": "Army Painter|Fanatic Core|Oak Brown", "brand": "Army Painter", "series": "Fanatic Core", "name": "Oak Brown", "hex": "#4f3723", "isMetallic": false, "isNeutral": true}, {"id": "Army Painter|Fanatic Core|Dragon Red", "brand": "Army Painter", "series": "Fanatic Core", "name": "Dragon Red", "hex": "#8e1d1d", "isMetallic": false, "isNeutral": false}, {"id": "Army Painter|Fanatic Core|Crystal Blue", "brand": "Army Painter", "series": "Fanatic Core", "name": "Crystal Blue", "hex": "#3a93d1", "isMetallic": false, "isNeutral": false}, {"id": "Army Painter|Fanatic Core|Ultramarine Blue", "brand": "Army Painter", "series": "Fanatic Core", "name": "Ultramarine Blue", "hex": "#1e4aa1", "isMetallic": false, "isNeutral": false}, {"id": "Army Painter|Fanatic Core|Angel Green", "brand": "Army Painter", "series": "Fanatic Core", "name": "Angel Green", "hex": "#2b6b3a", "isMetallic": false, "isNeutral": false}, {"id": "Army Painter|Fanatic Core|Military Green", "brand": "Army Painter", "series": "Fanatic Core", "name": "Military Green", "hex": "#556b3d", "isMetallic": false, "isNeutral": false}, {"id": "Army Painter|Fanatic Core|Ash Grey", "brand": "Army Painter", "series": "Fanatic Core", "name": "Ash Grey", "hex": "#9aa2a9", "isMetallic": false, "isNeutral": true}, {"id": "Army Painter|Metallics|Plate Mail Metal", "brand": "Army Painter", "series": "Metallics", "name": "Plate Mail Metal", "hex": "#a7adb3", "isMetallic": true, "isNeutral": false}, {"id": "Army Painter|Metallics|Gun Metal", "brand": "Army Painter", "series": "Metallics", "name": "Gun Metal", "hex": "#7e858c", "isMetallic": true, "isNeutral": false}, {"id": "Army Painter|Metallics|Weapon Bronze", "brand": "Army Painter", "series": "Metallics", "name": "Weapon Bronze", "hex": "#8a6030", "isMetallic": true, "isNeutral": false}, {"id": "Army Painter|Metallics|Greedy Gold", "brand": "Army Painter", "series": "Metallics", "name": "Greedy Gold", "hex": "#b5892e", "isMetallic": true, "isNeutral": false}, {"id": "Army Painter|Speedpaint|Blood Red", "brand": "Army Painter", "series": "Speedpaint", "name": "Blood Red", "hex": "#a0282e", "isMetallic": false, "isNeutral": false}, {"id": "Army Painter|Speedpaint|Magic Blue", "brand": "Army Painter", "series": "Speedpaint", "name": "Magic Blue", "hex": "#2f6fbf", "isMetallic": false, "isNeutral": false}, {"id": "Army Painter|Speedpaint|Hardened Leather", "brand": "Army Painter", "series": "Speedpaint", "name": "Hardened Leather", "hex": "#7a5b3a", "isMetallic": false, "isNeutral": true}, {"id": "Army Painter|Speedpaint|Gravelord Grey", "brand": "Army Painter", "series": "Speedpaint", "name": "Gravelord Grey", "hex": "#3a3f46", "isMetallic": false, "isNeutral": true}, {"id": "Army Painter|Fanatic Core|Desert Yellow", "brand": "Army Painter", "series": "Fanatic Core", "name": "Desert Yellow", "hex": "#cdb46a", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Model Color|Black", "brand": "Vallejo", "series": "Model Color", "name": "Black", "hex": "#0a0b0d", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Model Color|White", "brand": "Vallejo", "series": "Model Color", "name": "White", "hex": "#f4f6f7", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Model Color|Neutral Grey", "brand": "Vallejo", "series": "Model Color", "name": "Neutral Grey", "hex": "#8f969e", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Model Color|German Grey", "brand": "Vallejo", "series": "Model Color", "name": "German Grey", "hex": "#43474f", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Model Color|Dark Sand", "brand": "Vallejo", "series": "Model Color", "name": "Dark Sand", "hex": "#cbb27a", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Model Color|Khaki", "brand": "Vallejo", "series": "Model Color", "name": "Khaki", "hex": "#b9a67c", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Model Color|Chocolate Brown", "brand": "Vallejo", "series": "Model Color", "name": "Chocolate Brown", "hex": "#4b3424", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Model Color|Red", "brand": "Vallejo", "series": "Model Color", "name": "Red", "hex": "#a8262a", "isMetallic": false, "isNeutral": false}, {"id": "Vallejo|Model Color|Orange", "brand": "Vallejo", "series": "Model Color", "name": "Orange", "hex": "#e6712a", "isMetallic": false, "isNeutral": false}, {"id": "Vallejo|Model Color|Flat Yellow", "brand": "Vallejo", "series": "Model Color", "name": "Flat Yellow", "hex": "#f1cf2a", "isMetallic": false, "isNeutral": false}, {"id": "Vallejo|Model Color|Royal Blue", "brand": "Vallejo", "series": "Model Color", "name": "Royal Blue", "hex": "#214e9f", "isMetallic": false, "isNeutral": false}, {"id": "Vallejo|Model Color|Turquoise", "brand": "Vallejo", "series": "Model Color", "name": "Turquoise", "hex": "#2aa3a2", "isMetallic": false, "isNeutral": false}, {"id": "Vallejo|Model Color|Deep Green", "brand": "Vallejo", "series": "Model Color", "name": "Deep Green", "hex": "#1f5a3a", "isMetallic": false, "isNeutral": false}, {"id": "Vallejo|Game Color|Bloody Red", "brand": "Vallejo", "series": "Game Color", "name": "Bloody Red", "hex": "#b0272d", "isMetallic": false, "isNeutral": false}, {"id": "Vallejo|Game Color|Magic Blue", "brand": "Vallejo", "series": "Game Color", "name": "Magic Blue", "hex": "#2e6fc0", "isMetallic": false, "isNeutral": false}, {"id": "Vallejo|Game Color|Sombre Grey", "brand": "Vallejo", "series": "Game Color", "name": "Sombre Grey", "hex": "#4b5568", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Game Color|Cold Grey", "brand": "Vallejo", "series": "Game Color", "name": "Cold Grey", "hex": "#7f8a97", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Game Color|Bonewhite", "brand": "Vallejo", "series": "Game Color", "name": "Bonewhite", "hex": "#e3d5b7", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Xpress Color|Templar White", "brand": "Vallejo", "series": "Xpress Color", "name": "Templar White", "hex": "#f1f3f6", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Metal Color|Steel", "brand": "Vallejo", "series": "Metal Color", "name": "Steel", "hex": "#b3b8bf", "isMetallic": true, "isNeutral": false}, {"id": "Vallejo|Metal Color|Dark Aluminium", "brand": "Vallejo", "series": "Metal Color", "name": "Dark Aluminium", "hex": "#9aa1a9", "isMetallic": true, "isNeutral": false}, {"id": "Vallejo|Metal Color|Brass", "brand": "Vallejo", "series": "Metal Color", "name": "Brass", "hex": "#a07a3e", "isMetallic": true, "isNeutral": false}, {"id": "Vallejo|Metal Color|Silver", "brand": "Vallejo", "series": "Metal Color", "name": "Silver", "hex": "#cfd4db", "isMetallic": true, "isNeutral": false}, {"id": "Games Workshop|Layer|Teclis Blue", "brand": "Games Workshop", "series": "Layer", "name": "Teclis Blue", "hex": "#3a83d4", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Layer|Lothern Blue", "brand": "Games Workshop", "series": "Layer", "name": "Lothern Blue", "hex": "#5eb4e6", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Layer|Moot Green", "brand": "Games Workshop", "series": "Layer", "name": "Moot Green", "hex": "#7cd33a", "isMetallic": false, "isNeutral": false}, {"id": "Games Workshop|Layer|Screaming Skull", "brand": "Games Workshop", "series": "Layer", "name": "Screaming Skull", "hex": "#e1d7b7", "isMetallic": false, "isNeutral": true}, {"id": "Games Workshop|Base|Dryad Bark", "brand": "Games Workshop", "series": "Base", "name": "Dryad Bark", "hex": "#4a3726", "isMetallic": false, "isNeutral": true}, {"id": "Vallejo|Model Color|Olive Green", "brand": "Vallejo", "series": "Model Color", "name": "Olive Green", "hex": "#6e7a3c", "isMetallic": false, "isNeutral": false}, {"id": "Army Painter|Metallics|Rough Iron", "brand": "Army Painter", "series": "Metallics", "name": "Rough Iron", "hex": "#5c5e62", "isMetallic": true, "isNeutral": false}, {"id": "Army Painter|Fanatic Core|Uniform Grey", "brand": "Army Painter", "series": "Fanatic Core", "name": "Uniform Grey", "hex": "#7d858e", "isMetallic": false, "isNeutral": true}];
const themes = [{"id": 0, "label": "Grimdark", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 2, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 1, "label": "High Gothic", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "white|ivory", "defaultWeath": 0, "defaultEdge": 1, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 2, "label": "Industrial Brutal", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 2, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 3, "label": "Knightly Order", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 1, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 4, "label": "Ash Wastes", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 1, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 5, "label": "Storm-Forged", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 6, "label": "Verdant Ruin", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 7, "label": "Ember-forged", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 8, "label": "Arctic Patrol", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": -1, "neutralPref": "bone|brown|grey", "defaultWeath": 1, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 9, "label": "Desert Crusade", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 1, "neutralPref": "bone|brown|grey", "defaultWeath": 1, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 10, "label": "Urban Ops", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "grey|bone|black", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 11, "label": "Celestial Order", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 12, "label": "Blooded Vanguard", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 13, "label": "Bone and Iron", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "grey|bone|black", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 14, "label": "Oceanic Raid", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 15, "label": "Jungle Stalk", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 16, "label": "Siege-Worn", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 2, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 17, "label": "Relic-Kept", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 18, "label": "Monastic Cloister", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 19, "label": "Sunstruck Legion", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 20, "label": "Night Hunt", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 21, "label": "Forge World Line", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 22, "label": "Freeblade Heraldry", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "white|ivory", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 23, "label": "Crusader Pilgrimage", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 24, "label": "Ghost Company", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": -1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 25, "label": "Winter March", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 26, "label": "Iron Pact", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "grey|bone|black", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 27, "label": "Skyward Armada", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 28, "label": "Dune Raiders", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 1, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 29, "label": "Charnel Guard", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 30, "label": "Ceremonial Parade", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 1, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 31, "label": "Frontier Militia", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 1, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 32, "label": "Witch-Hunter Retinue", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 33, "label": "Artificer's Guild", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 34, "label": "Cel-Shaded", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 35, "label": "Noir Operatives", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": -1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 36, "label": "Sunless Depths", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 37, "label": "Argent Order", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 38, "label": "Arcane Mechanica", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 39, "label": "Royal Expedition", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 40, "label": "Rustbelt Infantry", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 2, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 41, "label": "Glacial Bastion", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": -1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 42, "label": "Ember Drakes", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 43, "label": "Verdigris Court", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 44, "label": "Martian Soil", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 1, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 45, "label": "Penitent Host", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 46, "label": "Solar Auxilia", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "white|ivory", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 47, "label": "Rogue Trader Chic", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 48, "label": "Veteran Company", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 49, "label": "Shrine World Guard", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 50, "label": "Tundra Recon", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 51, "label": "Fallen Relics", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 2, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 52, "label": "Meteor Knight", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 53, "label": "Siege Engineers", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 2, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 54, "label": "Cerulean Phalanx", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "white|ivory", "defaultWeath": 0, "defaultEdge": 1, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 55, "label": "Thornbriar", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 56, "label": "Gunmetal Opera", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "grey|bone|black", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 57, "label": "Ivory Host", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "white|ivory", "defaultWeath": 0, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 58, "label": "Sable and Gold", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 1, "neutralPref": "bone|brown|grey", "defaultWeath": 0, "defaultEdge": 1, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}, {"id": 59, "label": "Patrol Drab", "prompt": "Auto description. Tune colors and finishes per theme.", "biasTemp": 0, "neutralPref": "bone|brown|grey", "defaultWeath": 1, "defaultEdge": 0, "steps": ["Basecoat prime", "Layer and shade", "Edge highlight", "Finish touches"]}];
</script>
<script>
(function(){
  const state={
    paints:paints, shortlist:new Set(),
    filters:{brands:new Set(["Games Workshop","Army Painter","Vallejo"]),search:""},
    scheme:{themeId:0,primary:null,secondary:null,accent:null,contrast:null,neutral:null,metallicAccent:false,edge:0,weather:0},
    hashIndex:new Map(), paintIndex:new Map(), hashMemory:new Map(),
    previewMode:"armor"
  };
  function hash32(s){let h=0x811c9dc5>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=(h+((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24)))>>>0;}return h>>>0;}
  function crc16(bytes){let crc=0xFFFF;for(let i=0;i<bytes.length;i++){crc^=(bytes[i]<<8);for(let j=0;j<8;j++){if(crc&0x8000)crc=(crc<<1)^0x1021;else crc<<=1;crc&=0xFFFF;}}return crc;}
  function toB64Url(bytes){let bin=String.fromCharCode.apply(null,Array.from(bytes));return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
  function fromB64Url(str){str=str.replace(/-/g,'+').replace(/_/g,'/');const pad=(4-(str.length%4))%4;const bin=atob(str+'='.repeat(pad));const out=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)out[i]=bin.charCodeAt(i);return out;}
  function hexToRgb(h){h=h.replace('#','');if(h.length===3)h=h.split('').map(c=>c+c).join('');const n=parseInt(h,16);return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
  function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const M=Math.max(r,g,b),m=Math.min(r,g,b);let h,s,l=(M+m)/2;if(M===m){h=s=0;}else{const d=M-m;s=l>0.5?d/(2-M-m):d/(M+m);switch(M){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;default:h=(r-g)/d+4;}h/=6;}return {h:h*360,s,l};}
  function hueDiff(a,b){let d=Math.abs(a-b)%360;return d>180?360-d:d;}
  function lighten(hex,amt){const {r,g,b}=hexToRgb(hex);const t=amt>=0?255:0;const p=Math.abs(amt);const R=Math.round((t-r)*p)+r;const G=Math.round((t-g)*p)+g;const B=Math.round((t-b)*p)+b;return "#"+[R,G,B].map(v=>v.toString(16).padStart(2,'0')).join('');}
  function buildIndex(){state.paintIndex.clear();state.hashIndex.clear();for(const p of state.paints){state.paintIndex.set(p.id,p);const h=hash32(p.id)>>>0;if(!state.hashIndex.has(h))state.hashIndex.set(h,p.id);}}
  buildIndex();
  const q=(sel)=>document.querySelector(sel);
  const catalogGrid=q('#catalogGrid'), shortlistEl=q('#shortlist'), searchInput=q('#searchInput'), clearSearch=q('#clearSearch');
  const themeSelect=q('#themeSelect'), themePrompt=q('#themePrompt'), themeCount=q('#themeCount'), slotsEl=q('#slots'), stage=q('#stage');
  const codeInput=q('#codeInput'), toastEl=q('#toast');
  function showToast(m){toastEl.textContent=m;toastEl.style.display='block';setTimeout(()=>toastEl.style.display='none',1600);}
  function renderThemeSelect(){themeSelect.innerHTML='';for(const t of themes){const o=document.createElement('option');o.value=t.id;o.textContent=t.label;themeSelect.appendChild(o);}themeSelect.value=String(state.scheme.themeId);themeCount.textContent=`${themes.length} themes`;updateThemeDefaults();}
  function updateThemeDefaults(){const t=themes[state.scheme.themeId];themePrompt.textContent=t.prompt;state.scheme.weather=t.defaultWeath;state.scheme.edge=t.defaultEdge;renderPreview();renderDropdowns();updateNotes();updateCode();renderSteps();}
  function renderSteps(){const t=themes[state.scheme.themeId];const ul=document.getElementById('suggestedSteps');ul.innerHTML='';t.steps.forEach(s=>{const li=document.createElement('li');li.textContent=s;ul.appendChild(li);});}
  function brandFilterSet(){const brands=new Set([...document.querySelectorAll('.brandFilter')].filter(cb=>cb.checked).map(cb=>cb.value));state.filters.brands=brands;renderCatalog();renderDropdowns();}
  function renderCatalog(){const qv=state.filters.search.toLowerCase();const brands=state.filters.brands;const list=state.paints.filter(p=>brands.has(p.brand)&&(qv===''||p.name.toLowerCase().includes(qv)));catalogGrid.innerHTML='';list.forEach(p=>{const card=document.createElement('div');card.className='card';const sw=document.createElement('div');sw.className='swatch';sw.style.background=p.hex;const hex=document.createElement('div');hex.className='hex';hex.textContent=p.hex.toUpperCase();sw.appendChild(hex);const meta=document.createElement('div');meta.className='tiny';meta.style.padding='10px';meta.textContent=`${p.brand} • ${p.series}${p.isMetallic?' • metallic':''}${p.isNeutral?' • neutral':''}`;const title=document.createElement('div');title.style.padding='0 10px 10px';title.textContent=p.name;const actions=document.createElement('div');actions.className='actions';const add=document.createElement('button');add.textContent='+ Add to shortlist';add.onclick=()=>{state.shortlist.add(p.id);renderShortlist();};const assign=document.createElement('button');assign.textContent='Assign primary';assign.onclick=()=>setSlot('primary',p);actions.append(add,assign);card.append(sw,meta,title,actions);catalogGrid.appendChild(card);});}
  function renderShortlist(){shortlistEl.innerHTML='';for(const id of state.shortlist){const p=state.paintIndex.get(id);if(!p)continue;const el=document.createElement('div');el.className='mini';const dot=document.createElement('div');dot.className='dot';dot.style.background=p.hex;const txt=document.createElement('div');txt.textContent=`${p.brand.split(' ')[0]} ${p.name}`;const btn=document.createElement('button');btn.textContent='Assign primary';btn.onclick=()=>setSlot('primary',p);const rm=document.createElement('button');rm.textContent='Remove';rm.onclick=()=>{state.shortlist.delete(id);renderShortlist();};el.append(dot,txt,btn,rm);shortlistEl.appendChild(el);}}
  function renderDropdowns(){slotsEl.innerHTML='';const defs=[['primary','Primary color'],['secondary','Secondary color'],['accent','Accent color'],['contrast','Contrast color'],['neutral','Neutral color']];for(const [key,label] of defs){const div=document.createElement('div');div.className='slot';const lab=document.createElement('label');lab.textContent=label;const sw=document.createElement('div');sw.className='slot-swatch';sw.style.background=state.scheme[key]?.hex||'#0f131c';const sel=document.createElement('select');sel.dataset.slot=key;const auto=document.createElement('option');auto.value='__auto__';auto.textContent='Let app pick matching tone';const surprise=document.createElement('option');surprise.value='__surprise__';surprise.textContent='Surprise me';sel.append(auto,surprise);const qv=state.filters.search.toLowerCase();const brands=state.filters.brands;const list=state.paints.filter(p=>brands.has(p.brand)&&(!qv||p.name.toLowerCase().includes(qv))&&(key!=='neutral'||p.isNeutral)&&(!(key==='accent'&&state.scheme.metallicAccent) || p.isMetallic));list.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=`${p.series} - ${p.name}`;sel.appendChild(o);});if(state.scheme[key])sel.value=state.scheme[key].id;sel.onchange=onSlotSelectChange;div.append(lab,sw,sel);slotsEl.appendChild(div);}}
  function onSlotSelectChange(e){const slot=e.target.dataset.slot;const val=e.target.value;if(val==='__auto__'){surpriseSlot(slot,false);}else if(val==='__surprise__'){surpriseSlot(slot,true);}else{const p=state.paintIndex.get(val);if(p)setSlot(slot,p);}}
  function setSlot(slot,paint){state.scheme[slot]=paint;const h=hash32(paint.id)>>>0;if(!state.hashMemory.has(h))state.hashMemory.set(h,{...paint});renderDropdowns();renderPreview();updateNotes();updateCode();}
  function pickPrimary(){const ids=[...state.shortlist].filter(id=>{const p=state.paintIndex.get(id);return p&&state.filters.brands.has(p.brand);});const useShort=ids.length>0&&Math.random()<0.6;if(useShort){return state.paintIndex.get(ids[Math.floor(Math.random()*ids.length)]);}const pool=state.paints.filter(p=>state.filters.brands.has(p.brand)&&!p.isNeutral);return pool[Math.floor(Math.random()*pool.length)];}
  function rgbToHslHex(hex){const {r,g,b}=hexToRgb(hex);return rgbToHsl(r,g,b);}
  function candidates(mode,h){if(mode==='Complementary')return [(h+180)%360];if(mode==='Split-Complementary'){const opp=(h+180)%360;return [(opp+30)%360,(opp+330)%360];}if(mode==='Analogous'){const d=30;return [(h+d)%360,(h+360-d)%360];}if(mode==='Triadic'){return [(h+120)%360,(h+240)%360];}return [(h+170)%360];}
  function nearestHue(target,opts){let best=null,bestD=1e9;for(const p of opts){const h=rgbToHslHex(p.hex).h;const dh=hueDiff(target,h)/180;if(dh<bestD){bestD=dh;best=p;}}return best;}
  function pickNeutral(){const pool=state.paints.filter(p=>p.isNeutral&&state.filters.brands.has(p.brand));return pool[Math.floor(Math.random()*pool.length)];}
  function pickAccentMetal(target){const opts=state.paints.filter(p=>p.isMetallic&&state.filters.brands.has(p.brand));if(!opts.length)return null;return nearestHue(target,opts);}
  function generateScheme(){const modes=["Complementary","Split-Complementary","Analogous","Triadic","Neutral-Led"];const mode=modes[Math.floor(Math.random()*modes.length)];const primary=pickPrimary();const ph=rgbToHslHex(primary.hex).h;const hs=candidates(mode,ph);const nonNeutral=state.paints.filter(p=>state.filters.brands.has(p.brand)&&!p.isNeutral);let secondary=null,accent=null,contrast=null,neutral=null;if(mode==='Neutral-Led'){neutral=pickNeutral();const secH=(ph+(Math.random()<0.5?20:-20))%360;secondary=nearestHue(secH,nonNeutral);const accH=(ph+150+Math.random()*60)%360;accent=state.scheme.metallicAccent?(pickAccentMetal(accH)||nearestHue(accH,nonNeutral)):nearestHue(accH,nonNeutral);contrast=nonNeutral.sort((a,b)=>Math.abs(rgbToHslHex(b.hex).l-rgbToHslHex(primary.hex).l)-Math.abs(rgbToHslHex(a.hex).l-rgbToHslHex(primary.hex).l))[0];}else{secondary=nearestHue(hs[0],nonNeutral);const accH=hs[1]??((ph+180)%360);accent=state.scheme.metallicAccent?(pickAccentMetal(accH)||nearestHue(accH,nonNeutral)):nearestHue(accH,nonNeutral);contrast=nonNeutral.sort((a,b)=>Math.abs(rgbToHslHex(b.hex).l-rgbToHslHex(primary.hex).l)-Math.abs(rgbToHslHex(a.hex).l-rgbToHslHex(primary.hex).l))[0];neutral=pickNeutral();}state.scheme.primary=primary;state.scheme.secondary=secondary;state.scheme.accent=accent;state.scheme.contrast=contrast;state.scheme.neutral=neutral;["primary","secondary","accent","contrast","neutral"].forEach(k=>{const p=state.scheme[k];if(p){const h=hash32(p.id)>>>0;if(!state.hashMemory.has(h))state.hashMemory.set(h,{...p});}});renderDropdowns();renderPreview();updateNotes();updateCode();}
  function surpriseSlot(slot,fully){if(slot==='neutral'){setSlot('neutral',pickNeutral());return;}const base=state.scheme.primary||pickPrimary();const ph=rgbToHslHex(base.hex).h;const mode=fully?["Complementary","Split-Complementary","Analogous","Triadic"][Math.floor(Math.random()*4)]:"Analogous";const hs=candidates(mode,ph);let target=hs[0]??((ph+180)%360);if(slot==='secondary'&&hs.length>=1)target=hs[0];if(slot==='accent'&&hs.length>=2)target=hs[1];if(slot==='contrast'){const nonNeutral=state.paints.filter(p=>state.filters.brands.has(p.brand)&&!p.isNeutral);const choice=nonNeutral.sort((a,b)=>Math.abs(rgbToHslHex(b.hex).l-rgbToHslHex(base.hex).l)-Math.abs(rgbToHslHex(a.hex).l-rgbToHslHex(base.hex).l))[0];setSlot(slot,choice);return;}if(slot==='accent'&&state.scheme.metallicAccent){const m=pickAccentMetal(target);if(m){setSlot(slot,m);return;}}const options=state.paints.filter(p=>state.filters.brands.has(p.brand)&&!p.isNeutral);setSlot(slot,nearestHue(target,options));}
  function renderPreview(){stage.innerHTML='';const s=state.scheme;const P=s.primary?.hex||'#3a4a64',S=s.secondary?.hex||'#6b7c92',A=s.accent?.hex||'#c3a23a',C=s.contrast?.hex||'#e3e6ea',N=s.neutral?.hex||'#1a1f28';const w=stage.clientWidth||600,h=stage.clientHeight||230;const ns="http://www.w3.org/2000/svg";const svg=document.createElementNS(ns,'svg');svg.setAttribute('width','100%');svg.setAttribute('height','100%');svg.setAttribute('viewBox',`0 0 ${w} ${h}`);stage.appendChild(svg);function rect(x,y,W,H,col){const r=document.createElementNS(ns,'rect');r.setAttribute('x',x);r.setAttribute('y',y);r.setAttribute('width',W);r.setAttribute('height',H);r.setAttribute('rx',12);r.setAttribute('fill',col);svg.appendChild(r);}rect(14,14,w-28,h-28,N);rect(26,26,(w-52)*0.62,h-52,P);rect(26+(w-52)*0.62+8,26,(w-52)*0.30,h-52,S);rect(26+(w-52)*0.15,26+(h-52)*0.65,(w-52)*0.7,(h-52)*0.20,A);rect(26+(w-52)*0.02,26+(h-52)*0.20,(w-52)*0.58,(h-52)*0.12,C);}
  function updateNotes(){const s=state.scheme,t=themes[s.themeId];const L=p=>p?`${p.brand} - ${p.series} - ${p.name}`:'(unset)';const lines=[`Theme: ${t.label}`,'',`Primary: ${L(s.primary)}`,`Secondary: ${L(s.secondary)}`,`Accent: ${L(s.accent)}${s.metallicAccent?' [metallic]':''}`,`Contrast: ${L(s.contrast)}`,`Neutral: ${L(s.neutral)}`,'',`Edge: ${s.edge===0?'subtle':'high-contrast'} | Weathering: ${['none','light','heavy'][s.weather]}`];document.getElementById('recipeNotes').textContent=lines.join('\n');}
  function encodeRecipe(){const s=state.scheme;const getHash=p=>p?(hash32(p.id)>>>0):0;const bytes=new Uint8Array(23);let o=0;bytes[o++]=VERSION&0xFF;bytes[o++]=s.themeId&0xFF;const ids=[s.primary,s.secondary,s.accent,s.contrast,s.neutral];for(const p of ids){const h=getHash(p);bytes[o++]=(h>>>24)&0xFF;bytes[o++]=(h>>>16)&0xFF;bytes[o++]=(h>>>8)&0xFF;bytes[o++]=h&0xFF;}let flags=0;if(s.metallicAccent)flags|=1;if(s.edge===1)flags|=(1<<1);flags|=((s.weather&0x3)<<2);bytes[o++]=flags&0xFF;const crc=crc16(bytes);const out=new Uint8Array(25);out.set(bytes,0);out[23]=(crc>>>8)&0xFF;out[24]=crc&0xFF;return toB64Url(out);}
  function decodeRecipe(code){try{const all=fromB64Url(code);if(all.length!==25)throw new Error('Invalid length');const payload=all.slice(0,23);const crc=((all[23]<<8)|all[24]);const act=crc16(payload);if(act!==crc)throw new Error('CRC mismatch');let o=0;const ver=payload[o++];if(ver!==VERSION)throw new Error('Version mismatch');const themeId=payload[o++];const hashes=[];for(let i=0;i<5;i++){const h=(payload[o++]<<24)|(payload[o++]<<16)|(payload[o++]<<8)|(payload[o++]);hashes.push(h>>>0);}const flags=payload[o++];const metallic=!!(flags&1);const edge=!!(flags&(1<<1))?1:0;const weather=(flags>>2)&0x3;function hashToPaint(h){const id=state.hashIndex.get(h);if(id)return state.paintIndex.get(id);const snap=state.hashMemory.get(h);if(snap)return snap;return null;}const [p,s,acc,c,n]=hashes.map(hashToPaint);state.scheme.themeId=themeId;state.scheme.metallicAccent=metallic;state.scheme.edge=edge;state.scheme.weather=weather;state.scheme.primary=p;state.scheme.secondary=s;state.scheme.accent=acc;state.scheme.contrast=c;state.scheme.neutral=n;renderThemeSelect();renderDropdowns();renderPreview();updateNotes();showToast('Recipe loaded');}catch(e){showToast('Failed to load code');}}
  function updateCode(){codeInput.value=encodeRecipe();}
  // Events
  document.querySelectorAll('.brandFilter').forEach(cb=>cb.addEventListener('change',brandFilterSet));
  searchInput.oninput=()=>{state.filters.search=searchInput.value.trim();renderCatalog();renderDropdowns();};
  clearSearch.onclick=()=>{searchInput.value='';state.filters.search='';renderCatalog();renderDropdowns();};
  document.getElementById('generateBtn').onclick=()=>{const t=themes[state.scheme.themeId];state.scheme.weather=t.defaultWeath;state.scheme.edge=t.defaultEdge;generateScheme();};
  themeSelect.onchange=(e)=>{state.scheme.themeId=Number(e.target.value);updateThemeDefaults();};
  document.getElementById('accentMetallic').onchange=(e)=>{state.scheme.metallicAccent=e.target.checked;renderDropdowns();renderPreview();updateNotes();updateCode();};
  document.getElementById('edgeSel').onchange=(e)=>{state.scheme.edge=Number(e.target.value);renderPreview();updateNotes();updateCode();};
  document.getElementById('weathSel').onchange=(e)=>{state.scheme.weather=Number(e.target.value);updateNotes();updateCode();renderSteps();};
  document.getElementById('copyCode').onclick=async()=>{try{await navigator.clipboard.writeText(codeInput.value);showToast('Code copied');}catch{showToast('Copy failed');}};
  document.getElementById('loadCode').onclick=()=>decodeRecipe(codeInput.value.trim());
  // export/import
  function downloadJSON(obj,name){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),500);}
  document.getElementById('exportScheme').onclick=()=>{const s=state.scheme;const out={version:VERSION,themeId:s.themeId,themeLabel:themes[s.themeId].label,paints:['primary','secondary','accent','contrast','neutral'].reduce((o,k)=>{o[k]=s[k]?s[k].id:null;return o;},{}),metallicAccent:s.metallicAccent,edge:s.edge,weather:s.weather,code:encodeRecipe()};downloadJSON(out,'mpf_scheme.json');};
  document.getElementById('importScheme').onclick=async()=>{const file=document.getElementById('importSchemeFile').files[0];if(!file){showToast('Choose a JSON file');return;}const obj=JSON.parse(await file.text());if(obj.version!==VERSION){showToast('Version mismatch');return;}state.scheme.themeId=obj.themeId||0;const map=obj.paints||{};['primary','secondary','accent','contrast','neutral'].forEach(k=>{const id=map[k];state.scheme[k]=id?state.paintIndex.get(id)||{id,brand:id.split('|')[0],series:id.split('|')[1],name:id.split('|')[2],hex:'#7f8a97',isMetallic:false,isNeutral:false}:null;});state.scheme.metallicAccent=!!obj.metallicAccent;state.scheme.edge=obj.edge|0;state.scheme.weather=obj.weather|0;renderThemeSelect();renderDropdowns();renderPreview();updateNotes();updateCode();showToast('Scheme imported');};
  document.getElementById('exportPaints').onclick=()=>downloadJSON(state.paints,'mpf_paints.json');
  async function importPaints(replace){const file=document.getElementById('importPaintsFile').files[0];if(!file){showToast('Choose paints JSON');return;}const arr=JSON.parse(await file.text());const clean=arr.filter(p=>p&&p.id&&p.brand&&p.series&&p.name&&p.hex).map(p=>({id:String(p.id),brand:String(p.brand),series:String(p.series),name:String(p.name),hex:String(p.hex),isMetallic:!!p.isMetallic,isNeutral:!!p.isNeutral}));const merged=replace?clean:(()=>{const seen=new Set(state.paints.map(p=>p.id));const out=state.paints.slice();for(const p of clean){if(seen.has(p.id)){const i=out.findIndex(x=>x.id===p.id);out[i]=p;}else{out.push(p);seen.add(p.id);}}return out;})();// rebuild
    state.paints=merged;buildIndex();renderCatalog();renderDropdowns();showToast(replace?'Paints replaced':'Paints merged');}
  document.getElementById('importPaintsMerge').onclick=()=>importPaints(false);
  document.getElementById('importPaintsReplace').onclick=()=>importPaints(true);
  // Local storage
  const savedSelect=document.getElementById('savedSelect');
  function refreshSaved(){savedSelect.innerHTML='';const keys=Object.keys(localStorage).filter(k=>k.startsWith('mpf_')).sort();for(const k of keys){const opt=document.createElement('option');opt.value=k;opt.textContent=localStorage.getItem(k+'_label')||k.replace(/^mpf_/,'');savedSelect.appendChild(opt);}}
  document.getElementById('saveScheme').onclick=()=>{const label=prompt('Name this scheme:','My Scheme');if(!label)return;const key='mpf_'+label.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');localStorage.setItem(key,encodeRecipe());localStorage.setItem(key+'_label',label);refreshSaved();showToast('Saved');};
  document.getElementById('loadSaved').onclick=()=>{const key=savedSelect.value;if(!key){showToast('No saved');return;}const code=localStorage.getItem(key);if(!code){showToast('Missing');return;}codeInput.value=code;decodeRecipe(code);};
  document.getElementById('deleteSaved').onclick=()=>{const key=savedSelect.value;if(!key)return;localStorage.removeItem(key);localStorage.removeItem(key+'_label');refreshSaved();showToast('Deleted');};
  // Init
  function renderAll(){renderThemeSelect();renderCatalog();renderShortlist();renderDropdowns();renderPreview();refreshSaved();updateCode();}
  document.addEventListener('DOMContentLoaded',renderAll);renderAll();
})();
</script>
</body></html>
